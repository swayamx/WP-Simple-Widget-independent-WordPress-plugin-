name: PHP CI / WP-Simple-Widget (verbose)

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  php-ci:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ["7.4", "8.0", "8.1", "8.2"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print runner info
        run: |
          uname -a
          php --version || true
          composer --version || true

      - name: List repository files (top level)
        run: |
          echo "=== Root listing ==="
          ls -la
          echo "=== .github listing ==="
          ls -la .github || true
          echo "=== repo tree (shallow) ==="
          find . -maxdepth 2 -type f -print | sed -n '1,200p'

      - name: Set up PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v3
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, intl, curl
          ini-values: post_max_size=256M, memory_limit=2G
          tools: composer:v2

      - name: Debug environment variables
        run: env | sort

      - name: Validate composer & show composer.json if present
        run: |
          if [ -f composer.json ]; then
            echo "composer.json exists"
            jq . composer.json || cat composer.json
          else
            echo "No composer.json found"
          fi
        shell: bash

      - name: Install Composer dependencies (if composer.json present)
        if: ${{ hashFiles('**/composer.json') != '' }}
        run: |
          set -euo pipefail
          composer install --no-progress --prefer-dist --no-interaction
        shell: bash

      - name: Show existence of phpunit/phpcs and config
        run: |
          echo "vendor/bin files:"
          ls -la vendor/bin || true
          echo "phpunit.xml present?"; [ -f phpunit.xml ] && echo "yes" || echo "no"
          echo "phpcs config present?"; [ -f phpcs.xml ] && echo "yes" || echo "no"

      - name: Run PHPCS (if config present) — verbose
        if: ${{ hashFiles('**/phpcs.xml') != '' || hashFiles('**/phpcs.xml.dist') != '' || hashFiles('**/composer.json') != '' }}
        run: |
          set -euo pipefail
          echo "Running PHPCS..."
          if [ -f vendor/bin/phpcs ]; then
            vendor/bin/phpcs --standard=phpcs.xml --extensions=php --ignore=vendor . || { echo "PHPCS failed with exit $?: check output above"; exit 3; }
          else
            phpcs --standard=phpcs.xml --extensions=php --ignore=vendor . || { echo "PHPCS failed (no vendor phpcs). Exit code: $?. Exiting with 3"; exit 3; }
          fi
        shell: bash

      - name: Run PHPUnit tests (if tests exist) — verbose + produce junit
        if: ${{ hashFiles('**/tests/**/*.php') != '' || hashFiles('phpunit.xml') != '' || hashFiles('phpunit.xml.dist') != '' }}
        run: |
          set -euo pipefail
          echo "Running PHPUnit..."
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --configuration phpunit.xml || vendor/bin/phpunit --configuration phpunit.xml.dist || { echo "PHPUnit failed with exit $?"; exit 3; }
          else
            echo "vendor/bin/phpunit not found. Trying global phpunit..."
            phpunit --configuration phpunit.xml || phpunit --configuration phpunit.xml.dist || { echo "PHPUnit (global) failed with exit $?"; exit 3; }
          fi
        shell: bash

      - name: PHP syntax check for repo PHP files
        run: |
          set -euo pipefail
          files=$(git ls-files '*.php' | grep -v '^vendor/' || true)
          if [ -n "$files" ]; then
            echo "Checking PHP syntax of files:"
            echo "$files"
            for f in $files; do
              echo "-> lint $f"
              php -l "$f" || { echo "PHP lint failed for $f"; exit 3; }
            done
          else
            echo "No PHP files to lint"
          fi
        shell: bash

      - name: Upload PHPUnit logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-${{ matrix.php-version }}
          path: |
            ./phpunit.xml
            ./tests/logs || true
            ./build || true
          retention-days: 3
