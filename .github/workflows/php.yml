name: PHP CI — Composer safe

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  php-ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ["8.0"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v3
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, curl
          tools: composer:v2
          ini-values: memory_limit=2G

      - name: Show environment & files
        run: |
          php --version
          composer --version || true
          echo "composer.json exists?"; [ -f composer.json ] && echo "yes" || echo "no"
          echo "composer.lock exists?"; [ -f composer.lock ] && echo "yes" || echo "no"
          ls -la

      - name: Ensure composer (install fallback)
        run: |
          set -euo pipefail
          if ! command -v composer >/dev/null 2>&1; then
            echo "composer not found — installing composer locally"
            php -r "copy('https://getcomposer.org/installer','composer-setup.php');"
            php composer-setup.php --quiet
            mv composer.phar composer
            chmod +x composer
            mv composer /usr/local/bin/composer || true
          fi
          composer --version
        shell: bash

      - name: Composer install (guarded)
        if: ${{ hashFiles('**/composer.json') != '' }}
        env:
          COMPOSER_MEMORY_LIMIT: -1
        run: |
          set -euo pipefail
          echo "Composer install starting..."
          composer validate --no-check-publish || { echo "composer.json invalid"; composer validate --no-check-publish -vvv || true; exit 3; }
          composer config -g github-oauth.github.com "${{ secrets.GITHUB_TOKEN }}" || true
          composer install --no-interaction --prefer-dist --no-scripts -vvv || { echo "composer install failed — see above"; exit 3; }
        shell: bash
